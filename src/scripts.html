<script>
/**
 * Dashboard Client-Side Code
 * Loads data from AL_Extract via paginated server calls, renders table and summary.
 */

// ---- State ----
var contractData = [];
var filteredData = [];
var currentPage = 1;
var tablePageSize = 50;

// ---- Debug Logger (visible on screen) ----
function debugLog(msg) {
  console.log(msg);
  var el = document.getElementById('debugLog');
  if (el) {
    el.style.display = 'block';
    el.innerHTML += '<div>' + new Date().toLocaleTimeString() + ' — ' + msg + '</div>';
    el.scrollTop = el.scrollHeight;
  }
}

// ---- Init ----
document.addEventListener('DOMContentLoaded', function() {
  debugLog('DOM ready, starting dashboard init...');
  initializeDashboard();
});

function initializeDashboard() {
  showLoading(true, 'Connecting to data source...');
  
  // First: quick test with 5 rows to verify pipeline
  debugLog('Testing data pipeline with 5 rows...');
  google.script.run
    .withSuccessHandler(function(result) {
      debugLog('Test result: ' + JSON.stringify(result).substring(0, 300));
      if (result && result.success && result.data && result.data.length > 0) {
        debugLog('Pipeline OK. Columns: ' + (result.columns || []).join(', '));
        debugLog('Sample row: ' + JSON.stringify(result.data[0]).substring(0, 200));
        // Pipeline works — now load all data in pages
        loadAllPages();
      } else {
        debugLog('ERROR: Test returned no data. Result: ' + JSON.stringify(result));
        showLoading(false);
        showError('No data returned from AL_Extract sheet. Check that the sheet exists and has data starting at row 3.');
      }
    })
    .withFailureHandler(function(err) {
      debugLog('ERROR in test call: ' + (err.message || err));
      showLoading(false);
      showError('Server error: ' + (err.message || err));
    })
    .getContractDataTest();
}

// ---- Paginated Data Loading ----
function loadAllPages() {
  debugLog('Getting contract info...');
  google.script.run
    .withSuccessHandler(function(info) {
      if (!info || !info.success) {
        debugLog('ERROR getting info: ' + JSON.stringify(info));
        showLoading(false);
        showError('Could not get contract info: ' + (info ? info.error : 'unknown'));
        return;
      }
      debugLog('Total data rows: ' + info.totalRows);
      var pageSize = 500;
      var totalPages = Math.ceil(info.totalRows / pageSize);
      debugLog('Will load ' + totalPages + ' pages of ' + pageSize + ' rows each');
      contractData = [];
      loadPage(0, totalPages, pageSize);
    })
    .withFailureHandler(function(err) {
      debugLog('ERROR getting info: ' + (err.message || err));
      showLoading(false);
      showError('Failed to get contract info: ' + (err.message || err));
    })
    .getContractInfo();
}

function loadPage(page, totalPages, pageSize) {
  if (page >= totalPages) {
    debugLog('All pages loaded. Total contracts: ' + contractData.length);
    finishLoading();
    return;
  }
  
  var pct = Math.round(((page + 1) / totalPages) * 100);
  showLoading(true, 'Loading page ' + (page + 1) + ' of ' + totalPages + ' (' + pct + '%)');
  debugLog('Loading page ' + (page + 1) + '/' + totalPages + '...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result && result.success && result.data) {
        contractData = contractData.concat(result.data);
        debugLog('Page ' + (page + 1) + ' loaded: ' + result.data.length + ' rows (total so far: ' + contractData.length + ')');
      } else {
        debugLog('Page ' + (page + 1) + ' returned no data: ' + JSON.stringify(result).substring(0, 200));
      }
      // Load next page
      loadPage(page + 1, totalPages, pageSize);
    })
    .withFailureHandler(function(err) {
      debugLog('ERROR loading page ' + (page + 1) + ': ' + (err.message || err));
      // Continue with what we have
      debugLog('Continuing with ' + contractData.length + ' contracts loaded so far');
      finishLoading();
    })
    .getContractPage(page, pageSize);
}

function finishLoading() {
  showLoading(false);
  
  if (contractData.length === 0) {
    debugLog('No contracts loaded!');
    showError('No contract data was loaded. Check the AL_Extract sheet.');
    return;
  }
  
  filteredData = contractData.slice();
  debugLog('Rendering dashboard with ' + contractData.length + ' contracts');
  
  // Populate filters
  populateFilters();
  
  // Render everything
  updateSummaryCards();
  renderTable(filteredData);
  setupEventListeners();
  
  debugLog('Dashboard ready.');
}

// ---- Summary Cards ----
function updateSummaryCards() {
  var active = 0, completed = 0, totalCeiling = 0;
  for (var i = 0; i < filteredData.length; i++) {
    var c = filteredData[i];
    var status = String(c.AWARD_STATUS || '').toLowerCase();
    if (status === 'active') active++;
    if (status === 'completed' || status === 'closed') completed++;
    totalCeiling += (parseFloat(c.CEILING) || 0);
  }
  
  setText('totalValue', formatMoney(totalCeiling));
  setText('activeCount', String(active));
  setText('completedCount', String(completed));
  setText('budgetUtilization', filteredData.length + ' total');
}

function formatMoney(n) {
  if (n >= 1e9) return '$' + (n / 1e9).toFixed(1) + 'B';
  if (n >= 1e6) return '$' + (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return '$' + (n / 1e3).toFixed(1) + 'K';
  return '$' + n.toFixed(0);
}

function setText(id, text) {
  var el = document.getElementById(id);
  if (el) el.textContent = text;
}

// ---- Table Rendering ----
function renderTable(data) {
  var tbody = document.querySelector('#contractsTable tbody');
  if (!tbody) { debugLog('ERROR: #contractsTable tbody not found'); return; }
  
  tbody.innerHTML = '';
  
  if (!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;">No contracts found.</td></tr>';
    setText('paginationInfo', 'Showing 0 of 0 contracts');
    return;
  }
  
  // Paginate
  var start = (currentPage - 1) * tablePageSize;
  var end = Math.min(start + tablePageSize, data.length);
  var pageData = data.slice(start, end);
  
  for (var i = 0; i < pageData.length; i++) {
    var c = pageData[i];
    var tr = document.createElement('tr');
    tr.innerHTML = 
      '<td>' + esc(c.AWARD) + '</td>' +
      '<td>' + esc(c.PROJECT_TITLE || c.PROJECT) + '</td>' +
      '<td>' + formatMoney(parseFloat(c.CEILING) || 0) + '</td>' +
      '<td>' + formatMoney(parseFloat(c.CEILING) || 0) + '</td>' +
      '<td><span class="status-badge ' + statusClass(c.AWARD_STATUS) + '">' + esc(c.AWARD_STATUS) + '</span></td>' +
      '<td>' + formatDate(c.PROJECT_START) + '</td>' +
      '<td>' + formatDate(c.PROJECT_END) + '</td>' +
      '<td>' + esc(c.Client_Bureau || c.client_organization) + '</td>';
    tbody.appendChild(tr);
  }
  
  setText('paginationInfo', 'Showing ' + (start + 1) + '-' + end + ' of ' + data.length + ' contracts');
  updatePaginationButtons(data.length);
}

function esc(val) {
  if (val === null || val === undefined || val === '') return '—';
  var s = String(val);
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function statusClass(status) {
  if (!status) return 'status-default';
  var s = String(status).toLowerCase();
  if (s.indexOf('active') >= 0) return 'status-active';
  if (s.indexOf('completed') >= 0 || s.indexOf('closed') >= 0) return 'status-completed';
  if (s.indexOf('pending') >= 0) return 'status-pending';
  if (s.indexOf('cancel') >= 0) return 'status-cancelled';
  return 'status-default';
}

function formatDate(d) {
  if (!d) return '—';
  try {
    var dt = new Date(d);
    if (isNaN(dt.getTime())) return String(d);
    return dt.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  } catch(e) { return String(d); }
}

function updatePaginationButtons(totalRows) {
  var totalPages = Math.ceil(totalRows / tablePageSize);
  var prev = document.getElementById('prevPageBtn');
  var next = document.getElementById('nextPageBtn');
  var nums = document.getElementById('pageNumbers');
  
  if (prev) prev.disabled = (currentPage <= 1);
  if (next) next.disabled = (currentPage >= totalPages);
  if (nums) nums.textContent = 'Page ' + currentPage + ' of ' + totalPages;
}

// ---- Filters ----
function populateFilters() {
  var statuses = {}, orgs = {}, types = {};
  for (var i = 0; i < contractData.length; i++) {
    var c = contractData[i];
    if (c.AWARD_STATUS) statuses[c.AWARD_STATUS] = true;
    var org = c.Client_Bureau || c.client_organization;
    if (org) orgs[org] = true;
    if (c.CONTRACT_TYPE) types[c.CONTRACT_TYPE] = true;
  }
  
  fillSelect('statusFilter', Object.keys(statuses).sort());
  fillSelect('organizationFilter', Object.keys(orgs).sort());
  fillSelect('contractTypeFilter', Object.keys(types).sort());
}

function fillSelect(id, options) {
  var sel = document.getElementById(id);
  if (!sel) return;
  sel.innerHTML = '';
  for (var i = 0; i < options.length; i++) {
    var opt = document.createElement('option');
    opt.value = options[i];
    opt.textContent = options[i];
    sel.appendChild(opt);
  }
}

function applyFilters() {
  filteredData = contractData.slice();
  
  // Text search
  var search = (document.getElementById('searchInput') || {}).value || '';
  if (search.length > 0) {
    var term = search.toLowerCase();
    filteredData = filteredData.filter(function(c) {
      return (String(c.AWARD || '').toLowerCase().indexOf(term) >= 0) ||
             (String(c.PROJECT || '').toLowerCase().indexOf(term) >= 0) ||
             (String(c.PROJECT_TITLE || '').toLowerCase().indexOf(term) >= 0) ||
             (String(c.Client_Bureau || '').toLowerCase().indexOf(term) >= 0) ||
             (String(c.client_organization || '').toLowerCase().indexOf(term) >= 0) ||
             (String(c.AWARD_STATUS || '').toLowerCase().indexOf(term) >= 0) ||
             (String(c.AWARD_TITLE || '').toLowerCase().indexOf(term) >= 0);
    });
  }
  
  // Status filter
  var statusSel = document.getElementById('statusFilter');
  if (statusSel) {
    var selected = Array.from(statusSel.selectedOptions).map(function(o) { return o.value; });
    if (selected.length > 0) {
      filteredData = filteredData.filter(function(c) {
        return selected.indexOf(c.AWARD_STATUS) >= 0;
      });
    }
  }
  
  // Organization filter
  var orgSel = document.getElementById('organizationFilter');
  if (orgSel) {
    var selectedOrgs = Array.from(orgSel.selectedOptions).map(function(o) { return o.value; });
    if (selectedOrgs.length > 0) {
      filteredData = filteredData.filter(function(c) {
        return selectedOrgs.indexOf(c.Client_Bureau) >= 0 || selectedOrgs.indexOf(c.client_organization) >= 0;
      });
    }
  }
  
  // Contract type filter
  var typeSel = document.getElementById('contractTypeFilter');
  if (typeSel) {
    var selectedTypes = Array.from(typeSel.selectedOptions).map(function(o) { return o.value; });
    if (selectedTypes.length > 0) {
      filteredData = filteredData.filter(function(c) {
        return selectedTypes.indexOf(c.CONTRACT_TYPE) >= 0;
      });
    }
  }
  
  currentPage = 1;
  updateSummaryCards();
  renderTable(filteredData);
}

// ---- Event Listeners ----
function setupEventListeners() {
  // Search
  var searchInput = document.getElementById('searchInput');
  if (searchInput) {
    var searchTimer = null;
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(applyFilters, 300);
    });
  }
  
  // Clear search
  var clearBtn = document.getElementById('clearSearchBtn');
  if (clearBtn) {
    clearBtn.addEventListener('click', function() {
      document.getElementById('searchInput').value = '';
      applyFilters();
    });
  }
  
  // Filter selects
  ['statusFilter', 'organizationFilter', 'contractTypeFilter'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.addEventListener('change', applyFilters);
  });
  
  // Clear all filters
  var clearAll = document.getElementById('clearFiltersBtn');
  if (clearAll) {
    clearAll.addEventListener('click', function() {
      document.getElementById('searchInput').value = '';
      ['statusFilter', 'organizationFilter', 'contractTypeFilter'].forEach(function(id) {
        var sel = document.getElementById(id);
        if (sel) sel.selectedIndex = -1;
      });
      applyFilters();
    });
  }
  
  var clearAllActive = document.getElementById('clearAllActiveFilters');
  if (clearAllActive) {
    clearAllActive.addEventListener('click', function() {
      document.getElementById('clearFiltersBtn').click();
    });
  }
  
  // Pagination
  var prevBtn = document.getElementById('prevPageBtn');
  var nextBtn = document.getElementById('nextPageBtn');
  if (prevBtn) prevBtn.addEventListener('click', function() {
    if (currentPage > 1) { currentPage--; renderTable(filteredData); }
  });
  if (nextBtn) nextBtn.addEventListener('click', function() {
    var totalPages = Math.ceil(filteredData.length / tablePageSize);
    if (currentPage < totalPages) { currentPage++; renderTable(filteredData); }
  });
  
  // Page size
  var pageSizeSel = document.getElementById('pageSizeSelect');
  if (pageSizeSel) {
    pageSizeSel.addEventListener('change', function() {
      tablePageSize = parseInt(this.value) || 50;
      currentPage = 1;
      renderTable(filteredData);
    });
  }
  
  // Refresh
  var refreshBtn = document.getElementById('refreshBtn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', function() {
      contractData = [];
      filteredData = [];
      currentPage = 1;
      initializeDashboard();
    });
  }
  
  // Export button (simple CSV)
  var exportBtn = document.getElementById('exportBtn');
  if (exportBtn) {
    exportBtn.addEventListener('click', function() {
      exportCSV(filteredData);
    });
  }
  
  var exportTableBtn = document.getElementById('exportTableBtn');
  if (exportTableBtn) {
    exportTableBtn.addEventListener('click', function() {
      exportCSV(filteredData);
    });
  }
}

// ---- Export ----
function exportCSV(data) {
  if (!data || data.length === 0) { alert('No data to export'); return; }
  var keys = Object.keys(data[0]);
  var csv = keys.join(',') + '\n';
  for (var i = 0; i < data.length; i++) {
    var row = keys.map(function(k) {
      var v = String(data[i][k] || '').replace(/"/g, '""');
      return '"' + v + '"';
    });
    csv += row.join(',') + '\n';
  }
  var blob = new Blob([csv], { type: 'text/csv' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'contracts_export.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ---- Loading / Error UI ----
function showLoading(show, message) {
  var overlay = document.getElementById('loadingOverlay');
  if (overlay) overlay.style.display = show ? 'flex' : 'none';
  if (message) {
    var txt = document.querySelector('.loading-text');
    if (txt) txt.textContent = message;
  }
}

function showError(message) {
  debugLog('ERROR: ' + message);
  var errMsg = document.getElementById('errorMessage');
  var errModal = document.getElementById('errorModal');
  if (errMsg) errMsg.textContent = message;
  if (errModal) errModal.style.display = 'block';
}

function closeErrorModal() {
  var m = document.getElementById('errorModal');
  if (m) m.style.display = 'none';
}
</script>
