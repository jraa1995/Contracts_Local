<script>
/**
 * Dashboard Client-Side Code
 * Loads data from AL_Extract via paginated server calls, renders table and summary.
 */

// ---- State ----
var contractData = [];
var filteredData = [];
var currentPage = 1;
var tablePageSize = 50;

// ---- Debug Logger (console only) ----
function debugLog(msg) {
  console.log(new Date().toLocaleTimeString() + ' — ' + msg);
}

// ---- Init ----
document.addEventListener('DOMContentLoaded', function() {
  debugLog('DOM ready, starting dashboard init...');
  initializeDashboard();
});

function initializeDashboard() {
  showLoading(true, 'Connecting to data source...');
  
  // First: quick test with 5 rows to verify pipeline
  debugLog('Testing data pipeline with 5 rows...');
  google.script.run
    .withSuccessHandler(function(result) {
      debugLog('Test result: ' + JSON.stringify(result).substring(0, 300));
      if (result && result.success && result.data && result.data.length > 0) {
        debugLog('Pipeline OK. Columns: ' + (result.columns || []).join(', '));
        debugLog('Sample row: ' + JSON.stringify(result.data[0]).substring(0, 200));
        // Pipeline works — now load all data in pages
        loadAllPages();
      } else {
        debugLog('ERROR: Test returned no data. Result: ' + JSON.stringify(result));
        showLoading(false);
        showError('No data returned from AL_Extract sheet. Check that the sheet exists and has data starting at row 3.');
      }
    })
    .withFailureHandler(function(err) {
      debugLog('ERROR in test call: ' + (err.message || err));
      showLoading(false);
      showError('Server error: ' + (err.message || err));
    })
    .getContractDataTest();
}

// ---- Paginated Data Loading ----
function loadAllPages() {
  debugLog('Getting contract info...');
  google.script.run
    .withSuccessHandler(function(info) {
      if (!info || !info.success) {
        debugLog('ERROR getting info: ' + JSON.stringify(info));
        showLoading(false);
        showError('Could not get contract info: ' + (info ? info.error : 'unknown'));
        return;
      }
      debugLog('Total data rows: ' + info.totalRows);
      var pageSize = 500;
      var totalPages = Math.ceil(info.totalRows / pageSize);
      debugLog('Will load ' + totalPages + ' pages of ' + pageSize + ' rows each');
      contractData = [];
      loadPage(0, totalPages, pageSize);
    })
    .withFailureHandler(function(err) {
      debugLog('ERROR getting info: ' + (err.message || err));
      showLoading(false);
      showError('Failed to get contract info: ' + (err.message || err));
    })
    .getContractInfo();
}

function loadPage(page, totalPages, pageSize) {
  if (page >= totalPages) {
    debugLog('All pages loaded. Total contracts: ' + contractData.length);
    finishLoading();
    return;
  }
  
  var pct = Math.round(((page + 1) / totalPages) * 100);
  showLoading(true, 'Loading page ' + (page + 1) + ' of ' + totalPages + ' (' + pct + '%)');
  debugLog('Loading page ' + (page + 1) + '/' + totalPages + '...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result && result.success && result.data) {
        contractData = contractData.concat(result.data);
        debugLog('Page ' + (page + 1) + ' loaded: ' + result.data.length + ' rows (total so far: ' + contractData.length + ')');
      } else {
        debugLog('Page ' + (page + 1) + ' returned no data: ' + JSON.stringify(result).substring(0, 200));
      }
      // Load next page
      loadPage(page + 1, totalPages, pageSize);
    })
    .withFailureHandler(function(err) {
      debugLog('ERROR loading page ' + (page + 1) + ': ' + (err.message || err));
      // Continue with what we have
      debugLog('Continuing with ' + contractData.length + ' contracts loaded so far');
      finishLoading();
    })
    .getContractPage(page, pageSize);
}

function finishLoading() {
  showLoading(false);
  
  if (contractData.length === 0) {
    debugLog('No contracts loaded!');
    showError('No contract data was loaded. Check the AL_Extract sheet.');
    return;
  }
  
  filteredData = contractData.slice();
  debugLog('Rendering dashboard with ' + contractData.length + ' contracts');
  
  // Populate filters
  populateFilters();
  
  // Render everything
  updateSummaryCards();
  renderTable(filteredData);
  setupEventListeners();
  ChartManager.init(filteredData);
  
  debugLog('Dashboard ready.');
}

// ---- Summary Cards ----
function updateSummaryCards() {
  var active = 0, completed = 0, totalCeiling = 0;
  for (var i = 0; i < filteredData.length; i++) {
    var c = filteredData[i];
    var status = String(c.AWARD_STATUS || '').toLowerCase();
    if (status === 'active') active++;
    if (status === 'completed' || status === 'closed') completed++;
    totalCeiling += (parseFloat(c.CEILING) || 0);
  }
  
  setText('totalValue', formatMoney(totalCeiling));
  setText('activeCount', String(active));
  setText('completedCount', String(completed));
  setText('budgetUtilization', filteredData.length + ' total');
}

function formatMoney(n) {
  if (n >= 1e9) return '$' + (n / 1e9).toFixed(1) + 'B';
  if (n >= 1e6) return '$' + (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return '$' + (n / 1e3).toFixed(1) + 'K';
  return '$' + n.toFixed(0);
}

function setText(id, text) {
  var el = document.getElementById(id);
  if (el) el.textContent = text;
}

// ---- Table Rendering ----
function renderTable(data) {
  var tbody = document.querySelector('#contractsTable tbody');
  if (!tbody) { debugLog('ERROR: #contractsTable tbody not found'); return; }
  
  tbody.innerHTML = '';
  
  if (!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;">No contracts found.</td></tr>';
    setText('paginationInfo', 'Showing 0 of 0 contracts');
    return;
  }
  
  // Paginate
  var start = (currentPage - 1) * tablePageSize;
  var end = Math.min(start + tablePageSize, data.length);
  var pageData = data.slice(start, end);
  
  for (var i = 0; i < pageData.length; i++) {
    var c = pageData[i];
    var tr = document.createElement('tr');
    tr.innerHTML = 
      '<td>' + esc(c.AWARD) + '</td>' +
      '<td>' + esc(c.PROJECT_TITLE || c.PROJECT) + '</td>' +
      '<td>N/A</td>' +
      '<td>' + formatMoney(parseFloat(c.CEILING) || 0) + '</td>' +
      '<td><span class="status-badge ' + statusClass(c.AWARD_STATUS) + '">' + esc(c.AWARD_STATUS) + '</span></td>' +
      '<td>' + formatDate(c.PROJECT_START) + '</td>' +
      '<td>' + formatDate(c.PROJECT_END) + '</td>' +
      '<td>' + esc(c.Client_Bureau || c.client_organization) + '</td>';
    tbody.appendChild(tr);
  }
  
  setText('paginationInfo', 'Showing ' + (start + 1) + '-' + end + ' of ' + data.length + ' contracts');
  updatePaginationButtons(data.length);
}

function esc(val) {
  if (val === null || val === undefined || val === '') return '—';
  var s = String(val);
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function statusClass(status) {
  if (!status) return 'status-default';
  var s = String(status).toLowerCase();
  if (s.indexOf('active') >= 0) return 'status-active';
  if (s.indexOf('completed') >= 0 || s.indexOf('closed') >= 0) return 'status-completed';
  if (s.indexOf('pending') >= 0) return 'status-pending';
  if (s.indexOf('cancel') >= 0) return 'status-cancelled';
  return 'status-default';
}

function formatDate(d) {
  if (!d) return '—';
  try {
    var dt = new Date(d);
    if (isNaN(dt.getTime())) return String(d);
    return dt.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  } catch(e) { return String(d); }
}

function updatePaginationButtons(totalRows) {
  var totalPages = Math.ceil(totalRows / tablePageSize);
  var prev = document.getElementById('prevPageBtn');
  var next = document.getElementById('nextPageBtn');
  var nums = document.getElementById('pageNumbers');
  
  if (prev) prev.disabled = (currentPage <= 1);
  if (next) next.disabled = (currentPage >= totalPages);
  if (nums) nums.textContent = 'Page ' + currentPage + ' of ' + totalPages;
}

// ---- Filters ----
function populateFilters() {
  var statuses = {}, orgs = {}, types = {};
  for (var i = 0; i < contractData.length; i++) {
    var c = contractData[i];
    if (c.AWARD_STATUS) statuses[c.AWARD_STATUS] = true;
    var org = c.Client_Bureau || c.client_organization;
    if (org) orgs[org] = true;
    if (c.CONTRACT_TYPE) types[c.CONTRACT_TYPE] = true;
  }
  
  fillSelect('statusFilter', Object.keys(statuses).sort());
  fillSelect('organizationFilter', Object.keys(orgs).sort());
  fillSelect('contractTypeFilter', Object.keys(types).sort());
  
  // Build checkbox dropdown menus
  buildDropdownMenu('statusMenu', Object.keys(statuses).sort(), 'statusFilter', 'statusToggle', 'All Statuses');
  buildDropdownMenu('orgMenu', Object.keys(orgs).sort(), 'organizationFilter', 'orgToggle', 'All Organizations');
  buildDropdownMenu('typeMenu', Object.keys(types).sort(), 'contractTypeFilter', 'typeToggle', 'All Types');
  
  // Setup dropdown toggles
  setupDropdownToggle('statusToggle', 'statusMenu');
  setupDropdownToggle('orgToggle', 'orgMenu');
  setupDropdownToggle('typeToggle', 'typeMenu');
  
  // Close dropdowns on outside click
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.dropdown-select')) {
      document.querySelectorAll('.dropdown-menu').forEach(function(m) { m.classList.remove('open'); });
    }
  });
}

function buildDropdownMenu(menuId, options, selectId, toggleId, defaultLabel) {
  var menu = document.getElementById(menuId);
  if (!menu) return;
  menu.innerHTML = '';
  for (var i = 0; i < options.length; i++) {
    var item = document.createElement('div');
    item.className = 'dropdown-item';
    var cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.value = options[i];
    cb.id = menuId + '_' + i;
    var lbl = document.createElement('label');
    lbl.htmlFor = cb.id;
    lbl.textContent = options[i];
    item.appendChild(cb);
    item.appendChild(lbl);
    (function(checkbox) {
      checkbox.addEventListener('change', function() {
        syncDropdownToSelect(menuId, selectId);
        updateDropdownLabel(menuId, toggleId, defaultLabel);
        applyFilters();
      });
    })(cb);
    menu.appendChild(item);
  }
}

function setupDropdownToggle(toggleId, menuId) {
  var toggle = document.getElementById(toggleId);
  if (!toggle) return;
  toggle.addEventListener('click', function(e) {
    e.stopPropagation();
    // Close other dropdowns
    document.querySelectorAll('.dropdown-menu').forEach(function(m) {
      if (m.id !== menuId) m.classList.remove('open');
    });
    var menu = document.getElementById(menuId);
    if (menu) menu.classList.toggle('open');
  });
}

function syncDropdownToSelect(menuId, selectId) {
  var menu = document.getElementById(menuId);
  var sel = document.getElementById(selectId);
  if (!menu || !sel) return;
  // Clear all selections
  for (var i = 0; i < sel.options.length; i++) sel.options[i].selected = false;
  // Set selections from checkboxes
  var checkboxes = menu.querySelectorAll('input[type="checkbox"]:checked');
  checkboxes.forEach(function(cb) {
    for (var i = 0; i < sel.options.length; i++) {
      if (sel.options[i].value === cb.value) { sel.options[i].selected = true; break; }
    }
  });
}

function updateDropdownLabel(menuId, toggleId, defaultLabel) {
  var menu = document.getElementById(menuId);
  var toggle = document.getElementById(toggleId);
  if (!menu || !toggle) return;
  var checked = menu.querySelectorAll('input[type="checkbox"]:checked');
  if (checked.length === 0) {
    toggle.textContent = defaultLabel;
  } else if (checked.length === 1) {
    toggle.textContent = checked[0].value;
  } else {
    toggle.textContent = checked.length + ' selected';
  }
}

function fillSelect(id, options) {
  var sel = document.getElementById(id);
  if (!sel) return;
  sel.innerHTML = '';
  for (var i = 0; i < options.length; i++) {
    var opt = document.createElement('option');
    opt.value = options[i];
    opt.textContent = options[i];
    sel.appendChild(opt);
  }
}

function applyFilters() {
  filteredData = contractData.slice();
  
  // Text search
  var search = (document.getElementById('searchInput') || {}).value || '';
  if (search.length > 0) {
    var term = search.toLowerCase();
    filteredData = filteredData.filter(function(c) {
      return (String(c.AWARD || '').toLowerCase().indexOf(term) >= 0) ||
             (String(c.PROJECT || '').toLowerCase().indexOf(term) >= 0) ||
             (String(c.PROJECT_TITLE || '').toLowerCase().indexOf(term) >= 0) ||
             (String(c.Client_Bureau || '').toLowerCase().indexOf(term) >= 0) ||
             (String(c.client_organization || '').toLowerCase().indexOf(term) >= 0) ||
             (String(c.AWARD_STATUS || '').toLowerCase().indexOf(term) >= 0) ||
             (String(c.AWARD_TITLE || '').toLowerCase().indexOf(term) >= 0);
    });
  }
  
  // Status filter
  var statusSel = document.getElementById('statusFilter');
  if (statusSel) {
    var selected = Array.from(statusSel.selectedOptions).map(function(o) { return o.value; });
    if (selected.length > 0) {
      filteredData = filteredData.filter(function(c) {
        return selected.indexOf(c.AWARD_STATUS) >= 0;
      });
    }
  }
  
  // Organization filter
  var orgSel = document.getElementById('organizationFilter');
  if (orgSel) {
    var selectedOrgs = Array.from(orgSel.selectedOptions).map(function(o) { return o.value; });
    if (selectedOrgs.length > 0) {
      filteredData = filteredData.filter(function(c) {
        return selectedOrgs.indexOf(c.Client_Bureau) >= 0 || selectedOrgs.indexOf(c.client_organization) >= 0;
      });
    }
  }
  
  // Contract type filter
  var typeSel = document.getElementById('contractTypeFilter');
  if (typeSel) {
    var selectedTypes = Array.from(typeSel.selectedOptions).map(function(o) { return o.value; });
    if (selectedTypes.length > 0) {
      filteredData = filteredData.filter(function(c) {
        return selectedTypes.indexOf(c.CONTRACT_TYPE) >= 0;
      });
    }
  }
  
  // Date range filter
  var dateField = (document.getElementById('dateFieldSelect') || {}).value || 'projectStart';
  var dateStart = (document.getElementById('dateRangeStart') || {}).value || '';
  var dateEnd = (document.getElementById('dateRangeEnd') || {}).value || '';
  if (dateStart || dateEnd) {
    filteredData = filteredData.filter(function(c) {
      var field = dateField === 'projectEnd' ? c.PROJECT_END : c.PROJECT_START;
      if (!field) return false;
      try {
        var d = new Date(field);
        if (isNaN(d.getTime())) return false;
        if (dateStart && d < new Date(dateStart)) return false;
        if (dateEnd && d > new Date(dateEnd)) return false;
        return true;
      } catch(e) { return false; }
    });
  }
  
  // Financial range filter
  var finMin = parseFloat((document.getElementById('financialMin') || {}).value);
  var finMax = parseFloat((document.getElementById('financialMax') || {}).value);
  if (!isNaN(finMin) || !isNaN(finMax)) {
    filteredData = filteredData.filter(function(c) {
      var ceil = parseFloat(c.CEILING) || 0;
      if (!isNaN(finMin) && ceil < finMin) return false;
      if (!isNaN(finMax) && ceil > finMax) return false;
      return true;
    });
  }
  
  currentPage = 1;
  updateSummaryCards();
  renderTable(filteredData);
  ChartManager.updateAll(filteredData);
  updateActiveFilterTags();
}

// ---- Event Listeners ----
function setupEventListeners() {
  // Search
  var searchInput = document.getElementById('searchInput');
  if (searchInput) {
    var searchTimer = null;
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(applyFilters, 300);
    });
  }
  
  // Clear search
  var clearBtn = document.getElementById('clearSearchBtn');
  if (clearBtn) {
    clearBtn.addEventListener('click', function() {
      document.getElementById('searchInput').value = '';
      applyFilters();
    });
  }
  
  // Filter selects
  ['statusFilter', 'organizationFilter', 'contractTypeFilter'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.addEventListener('change', applyFilters);
  });
  
  // Clear all filters
  var clearAll = document.getElementById('clearFiltersBtn');
  if (clearAll) {
    clearAll.addEventListener('click', function() {
      document.getElementById('searchInput').value = '';
      ['statusFilter', 'organizationFilter', 'contractTypeFilter'].forEach(function(id) {
        var sel = document.getElementById(id);
        if (sel) sel.selectedIndex = -1;
      });
      // Uncheck all dropdown checkboxes and reset labels
      document.querySelectorAll('.dropdown-menu input[type="checkbox"]').forEach(function(cb) { cb.checked = false; });
      var toggleMap = { statusToggle: 'All Statuses', orgToggle: 'All Organizations', typeToggle: 'All Types' };
      for (var tid in toggleMap) {
        var t = document.getElementById(tid);
        if (t) t.textContent = toggleMap[tid];
      }
      // Clear date and financial inputs
      var dateStart = document.getElementById('dateRangeStart'); if (dateStart) dateStart.value = '';
      var dateEnd = document.getElementById('dateRangeEnd'); if (dateEnd) dateEnd.value = '';
      var finMin = document.getElementById('financialMin'); if (finMin) finMin.value = '';
      var finMax = document.getElementById('financialMax'); if (finMax) finMax.value = '';
      document.querySelectorAll('.date-preset-btn, .financial-preset-btn').forEach(function(b) { b.classList.remove('active'); });
      applyFilters();
    });
  }
  
  var clearAllActive = document.getElementById('clearAllActiveFilters');
  if (clearAllActive) {
    clearAllActive.addEventListener('click', function() {
      document.getElementById('clearFiltersBtn').click();
    });
  }
  
  // Pagination
  var prevBtn = document.getElementById('prevPageBtn');
  var nextBtn = document.getElementById('nextPageBtn');
  if (prevBtn) prevBtn.addEventListener('click', function() {
    if (currentPage > 1) { currentPage--; renderTable(filteredData); }
  });
  if (nextBtn) nextBtn.addEventListener('click', function() {
    var totalPages = Math.ceil(filteredData.length / tablePageSize);
    if (currentPage < totalPages) { currentPage++; renderTable(filteredData); }
  });
  
  // Page size
  var pageSizeSel = document.getElementById('pageSizeSelect');
  if (pageSizeSel) {
    pageSizeSel.addEventListener('change', function() {
      tablePageSize = parseInt(this.value) || 50;
      currentPage = 1;
      renderTable(filteredData);
    });
  }
  
  // Refresh
  var refreshBtn = document.getElementById('refreshBtn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', function() {
      contractData = [];
      filteredData = [];
      currentPage = 1;
      initializeDashboard();
    });
  }
  
  // Export button (simple CSV)
  var exportBtn = document.getElementById('exportBtn');
  if (exportBtn) {
    exportBtn.addEventListener('click', function() {
      exportCSV(filteredData);
    });
  }
  
  var exportTableBtn = document.getElementById('exportTableBtn');
  if (exportTableBtn) {
    exportTableBtn.addEventListener('click', function() {
      exportCSV(filteredData);
    });
  }
  
  // Date range inputs
  ['dateRangeStart', 'dateRangeEnd', 'dateFieldSelect'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.addEventListener('change', applyFilters);
  });
  
  // Financial range inputs
  ['financialMin', 'financialMax'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.addEventListener('change', applyFilters);
  });
  
  // Date preset buttons
  document.querySelectorAll('.date-preset-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var preset = btn.getAttribute('data-preset');
      var now = new Date();
      var start, end = now.toISOString().slice(0, 10);
      if (preset === 'last30') {
        start = new Date(now.getTime() - 30 * 86400000).toISOString().slice(0, 10);
      } else if (preset === 'last90') {
        start = new Date(now.getTime() - 90 * 86400000).toISOString().slice(0, 10);
      } else if (preset === 'thisYear') {
        start = now.getFullYear() + '-01-01';
        end = now.getFullYear() + '-12-31';
      }
      var startEl = document.getElementById('dateRangeStart');
      var endEl = document.getElementById('dateRangeEnd');
      if (startEl) startEl.value = start || '';
      if (endEl) endEl.value = end || '';
      // Toggle active class
      document.querySelectorAll('.date-preset-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      applyFilters();
    });
  });
  
  // Financial preset buttons
  document.querySelectorAll('.financial-preset-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var preset = btn.getAttribute('data-preset');
      var minEl = document.getElementById('financialMin');
      var maxEl = document.getElementById('financialMax');
      if (preset === 'under100k') {
        if (minEl) minEl.value = '0';
        if (maxEl) maxEl.value = '100000';
      } else if (preset === '100k-1m') {
        if (minEl) minEl.value = '100000';
        if (maxEl) maxEl.value = '1000000';
      } else if (preset === 'over1m') {
        if (minEl) minEl.value = '1000000';
        if (maxEl) maxEl.value = '';
      }
      document.querySelectorAll('.financial-preset-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      applyFilters();
    });
  });
  
  // Sort handlers
  setupSortHandlers();
}

// ---- Active Filter Tags ----
function updateActiveFilterTags() {
  var container = document.getElementById('activeFilters');
  var list = document.getElementById('activeFiltersList');
  if (!container || !list) return;
  
  list.innerHTML = '';
  var tags = [];
  
  // Search
  var search = (document.getElementById('searchInput') || {}).value || '';
  if (search) tags.push({ label: 'Search: ' + search, clear: function() { document.getElementById('searchInput').value = ''; } });
  
  // Status
  var statusSel = document.getElementById('statusFilter');
  if (statusSel) {
    var selected = Array.from(statusSel.selectedOptions).map(function(o) { return o.value; });
    if (selected.length > 0) tags.push({ label: 'Status: ' + selected.join(', '), clear: function() { statusSel.selectedIndex = -1; } });
  }
  
  // Organization
  var orgSel = document.getElementById('organizationFilter');
  if (orgSel) {
    var selectedOrgs = Array.from(orgSel.selectedOptions).map(function(o) { return o.value; });
    if (selectedOrgs.length > 0) tags.push({ label: 'Org: ' + selectedOrgs.join(', '), clear: function() { orgSel.selectedIndex = -1; } });
  }
  
  // Contract type
  var typeSel = document.getElementById('contractTypeFilter');
  if (typeSel) {
    var selectedTypes = Array.from(typeSel.selectedOptions).map(function(o) { return o.value; });
    if (selectedTypes.length > 0) tags.push({ label: 'Type: ' + selectedTypes.join(', '), clear: function() { typeSel.selectedIndex = -1; } });
  }
  
  // Date range
  var dateStart = (document.getElementById('dateRangeStart') || {}).value || '';
  var dateEnd = (document.getElementById('dateRangeEnd') || {}).value || '';
  if (dateStart || dateEnd) {
    tags.push({ label: 'Date: ' + (dateStart || '...') + ' to ' + (dateEnd || '...'), clear: function() {
      var s = document.getElementById('dateRangeStart'); if (s) s.value = '';
      var e = document.getElementById('dateRangeEnd'); if (e) e.value = '';
      document.querySelectorAll('.date-preset-btn').forEach(function(b) { b.classList.remove('active'); });
    }});
  }
  
  // Financial range
  var finMin = (document.getElementById('financialMin') || {}).value || '';
  var finMax = (document.getElementById('financialMax') || {}).value || '';
  if (finMin || finMax) {
    tags.push({ label: 'Financial: ' + (finMin ? '$' + Number(finMin).toLocaleString() : '...') + ' to ' + (finMax ? '$' + Number(finMax).toLocaleString() : '...'), clear: function() {
      var mn = document.getElementById('financialMin'); if (mn) mn.value = '';
      var mx = document.getElementById('financialMax'); if (mx) mx.value = '';
      document.querySelectorAll('.financial-preset-btn').forEach(function(b) { b.classList.remove('active'); });
    }});
  }
  
  if (tags.length === 0) {
    container.style.display = 'none';
    return;
  }
  
  container.style.display = '';
  tags.forEach(function(tag) {
    var el = document.createElement('span');
    el.className = 'active-filter-tag';
    el.innerHTML = tag.label + ' <button class="remove-filter">&times;</button>';
    el.querySelector('.remove-filter').addEventListener('click', function() {
      tag.clear();
      applyFilters();
    });
    list.appendChild(el);
  });
}

// ---- Export ----
function exportCSV(data) {
  if (!data || data.length === 0) { alert('No data to export'); return; }
  var keys = Object.keys(data[0]);
  var csv = keys.join(',') + '\n';
  for (var i = 0; i < data.length; i++) {
    var row = keys.map(function(k) {
      var v = String(data[i][k] || '').replace(/"/g, '""');
      return '"' + v + '"';
    });
    csv += row.join(',') + '\n';
  }
  var blob = new Blob([csv], { type: 'text/csv' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'contracts_export.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ---- Loading / Error UI ----
function showLoading(show, message) {
  var overlay = document.getElementById('loadingOverlay');
  if (overlay) overlay.style.display = show ? 'flex' : 'none';
  if (message) {
    var txt = document.querySelector('.loading-text');
    if (txt) txt.textContent = message;
  }
}

function showError(message) {
  debugLog('ERROR: ' + message);
  var errMsg = document.getElementById('errorMessage');
  var errModal = document.getElementById('errorModal');
  if (errMsg) errMsg.textContent = message;
  if (errModal) errModal.style.display = 'block';
}

function closeErrorModal() {
  var m = document.getElementById('errorModal');
  if (m) m.style.display = 'none';
}

// ============================================
// ChartManager — Chart.js rendering (grayscale)
// ============================================
var ChartManager = {
  chartInstances: { status: null, organization: null, timeline: null, trends: null },
  grayscaleColors: ['#1d1d1f', '#333', '#555', '#666', '#86868b', '#999', '#a1a1a6', '#d2d2d7'],

  getGrayscaleColor: function(index) {
    return this.grayscaleColors[index % this.grayscaleColors.length];
  },

  destroy: function() {
    for (var key in this.chartInstances) {
      if (this.chartInstances[key]) {
        this.chartInstances[key].destroy();
        this.chartInstances[key] = null;
      }
    }
  },

  init: function(data) {
    this.destroy();
    this.chartInstances.status = this.createStatusChart(data);
    this.chartInstances.organization = this.createOrganizationChart(data);
    this.chartInstances.timeline = this.createTimelineChart(data);
    this.chartInstances.trends = this.createTrendsChart(data);
  },

  updateAll: function(data) {
    this.init(data);
    // Flash the indicator
    var ind = document.getElementById('chartUpdateIndicator');
    if (ind) {
      ind.textContent = 'Updated';
      ind.classList.add('updated');
      setTimeout(function() { ind.textContent = 'Ready'; ind.classList.remove('updated'); }, 1500);
    }
  },

  showEmpty: function(canvasId) {
    var canvas = document.getElementById(canvasId);
    if (!canvas) return null;
    var parent = canvas.parentElement;
    canvas.style.display = 'none';
    var existing = parent.querySelector('.chart-empty');
    if (!existing) {
      var msg = document.createElement('div');
      msg.className = 'chart-empty';
      msg.textContent = 'No data available';
      parent.appendChild(msg);
    }
    return null;
  },

  clearEmpty: function(canvasId) {
    var canvas = document.getElementById(canvasId);
    if (!canvas) return;
    canvas.style.display = '';
    var parent = canvas.parentElement;
    var existing = parent.querySelector('.chart-empty');
    if (existing) existing.remove();
  },

  createStatusChart: function(data) {
    var counts = {};
    for (var i = 0; i < data.length; i++) {
      var s = String(data[i].AWARD_STATUS || 'Unknown');
      counts[s] = (counts[s] || 0) + 1;
    }
    var labels = Object.keys(counts);
    if (labels.length === 0) return this.showEmpty('statusChart');
    this.clearEmpty('statusChart');
    var canvas = document.getElementById('statusChart');
    if (!canvas) return null;
    var self = this;
    try {
      return new Chart(canvas, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{ data: labels.map(function(l) { return counts[l]; }),
            backgroundColor: labels.map(function(_, i) { return self.getGrayscaleColor(i); }),
            borderColor: '#fff', borderWidth: 2 }]
        },
        options: {
          responsive: true, maintainAspectRatio: true,
          plugins: { legend: { position: 'bottom', labels: { font: { family: '-apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif' }, color: '#666' } } }
        }
      });
    } catch(e) { debugLog('Chart error (status): ' + e.message); return this.showEmpty('statusChart'); }
  },

  createOrganizationChart: function(data) {
    var sums = {};
    for (var i = 0; i < data.length; i++) {
      var org = String(data[i].Client_Bureau || data[i].client_organization || 'Unknown');
      sums[org] = (sums[org] || 0) + (parseFloat(data[i].CEILING) || 0);
    }
    var entries = Object.keys(sums).map(function(o) { return { org: o, total: sums[o] }; });
    entries.sort(function(a, b) { return b.total - a.total; });
    entries = entries.slice(0, 10);
    if (entries.length === 0) return this.showEmpty('organizationChart');
    this.clearEmpty('organizationChart');
    var canvas = document.getElementById('organizationChart');
    if (!canvas) return null;
    var self = this;
    try {
      return new Chart(canvas, {
        type: 'bar',
        data: {
          labels: entries.map(function(e) { return e.org; }),
          datasets: [{ label: 'Ceiling Value', data: entries.map(function(e) { return e.total; }),
            backgroundColor: entries.map(function(_, i) { return self.getGrayscaleColor(i); }),
            borderColor: '#1d1d1f', borderWidth: 1 }]
        },
        options: {
          indexAxis: 'y', responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { callback: function(v) { return formatMoney(v); }, color: '#666', font: { family: '-apple-system, sans-serif', size: 11 } }, grid: { color: '#e8e8ed' } },
            y: { ticks: { color: '#666', font: { family: '-apple-system, sans-serif', size: 11 }, autoSkip: false }, grid: { display: false } }
          }
        }
      });
    } catch(e) { debugLog('Chart error (org): ' + e.message); return this.showEmpty('organizationChart'); }
  },

  createTimelineChart: function(data) {
    var counts = {};
    for (var i = 0; i < data.length; i++) {
      var d = data[i].PROJECT_START;
      if (!d) continue;
      var year = new Date(d).getFullYear();
      if (isNaN(year)) continue;
      counts[year] = (counts[year] || 0) + 1;
    }
    var years = Object.keys(counts).map(Number).sort(function(a,b){return a-b;});
    if (years.length === 0) return this.showEmpty('timelineChart');
    this.clearEmpty('timelineChart');
    var canvas = document.getElementById('timelineChart');
    if (!canvas) return null;
    try {
      return new Chart(canvas, {
        type: 'bar',
        data: {
          labels: years.map(String),
          datasets: [{ label: 'Contracts', data: years.map(function(y) { return counts[y]; }),
            backgroundColor: '#555', borderColor: '#333', borderWidth: 1 }]
        },
        options: {
          responsive: true, maintainAspectRatio: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#666' }, grid: { color: '#e8e8ed' } },
            y: { ticks: { color: '#666' }, grid: { color: '#e8e8ed' }, beginAtZero: true }
          }
        }
      });
    } catch(e) { debugLog('Chart error (timeline): ' + e.message); return this.showEmpty('timelineChart'); }
  },

  createTrendsChart: function(data) {
    var sums = {};
    for (var i = 0; i < data.length; i++) {
      var d = data[i].PROJECT_START;
      if (!d) continue;
      var year = new Date(d).getFullYear();
      if (isNaN(year)) continue;
      sums[year] = (sums[year] || 0) + (parseFloat(data[i].CEILING) || 0);
    }
    var years = Object.keys(sums).map(Number).sort(function(a,b){return a-b;});
    if (years.length === 0) return this.showEmpty('trendsChart');
    this.clearEmpty('trendsChart');
    var canvas = document.getElementById('trendsChart');
    if (!canvas) return null;
    try {
      return new Chart(canvas, {
        type: 'line',
        data: {
          labels: years.map(String),
          datasets: [{ label: 'Total Ceiling', data: years.map(function(y) { return sums[y]; }),
            borderColor: '#1d1d1f', backgroundColor: 'rgba(0,0,0,0.05)',
            fill: true, tension: 0.3, pointBackgroundColor: '#333', pointBorderColor: '#1d1d1f' }]
        },
        options: {
          responsive: true, maintainAspectRatio: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#666' }, grid: { color: '#e8e8ed' } },
            y: { ticks: { callback: function(v) { return formatMoney(v); }, color: '#666' }, grid: { color: '#e8e8ed' } }
          }
        }
      });
    } catch(e) { debugLog('Chart error (trends): ' + e.message); return this.showEmpty('trendsChart'); }
  }
};

// ============================================
// Table Sorting
// ============================================
var currentSortColumn = null;
var currentSortDirection = 'asc';

function setupSortHandlers() {
  var headers = document.querySelectorAll('th[data-sort]');
  headers.forEach(function(th) {
    th.addEventListener('click', function() {
      var col = th.getAttribute('data-sort');
      if (currentSortColumn === col) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortColumn = col;
        currentSortDirection = 'asc';
      }
      sortFilteredData();
      renderTable(filteredData);
      updateSortIndicators();
    });
  });
}

function sortFilteredData() {
  if (!currentSortColumn) return;
  filteredData.sort(function(a, b) {
    var valA = getSortValue(a, currentSortColumn);
    var valB = getSortValue(b, currentSortColumn);
    var cmp = compareSortValues(valA, valB, currentSortColumn);
    return currentSortDirection === 'desc' ? -cmp : cmp;
  });
}

function getSortValue(contract, column) {
  switch (column) {
    case 'award': return contract.AWARD || '';
    case 'project': return contract.PROJECT_TITLE || contract.PROJECT || '';
    case 'ceiling': return parseFloat(contract.CEILING) || 0;
    case 'awardValue': return 0; // N/A column
    case 'status': return contract.AWARD_STATUS || '';
    case 'projectStart': return contract.PROJECT_START || '';
    case 'projectEnd': return contract.PROJECT_END || '';
    case 'clientBureau': return contract.Client_Bureau || contract.client_organization || '';
    default: return '';
  }
}

function compareSortValues(a, b, column) {
  if (column === 'ceiling' || column === 'awardValue') return (a || 0) - (b || 0);
  if (column === 'projectStart' || column === 'projectEnd') {
    var da = a ? new Date(a).getTime() : 0;
    var db = b ? new Date(b).getTime() : 0;
    if (isNaN(da)) da = 0;
    if (isNaN(db)) db = 0;
    return da - db;
  }
  return String(a).localeCompare(String(b));
}

function updateSortIndicators() {
  var headers = document.querySelectorAll('th[data-sort]');
  headers.forEach(function(th) {
    th.classList.remove('sort-asc', 'sort-desc');
    if (th.getAttribute('data-sort') === currentSortColumn) {
      th.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
    }
  });
}
</script>
